name: PreRelease Sanity Check

permissions:
  actions: write
  contents: write
  
on:
  workflow_dispatch:
  push: 
    branches: [dev]

jobs:
  trigger-golang-ci-test:
    runs-on: ubuntu-latest
    steps:
      - uses: plengauer/opentelemetry-github/actions/instrument/job@v5.32.0
        env:
          OTEL_EXPORTER_OTLP_ENDPOINT: https://ingress.coralogix.us:443
          OTEL_EXPORTER_OTLP_HEADERS: 'Authorization: Bearer ${{ secrets.FASTCI_TOKEN }}'
        with:
          secrets_to_redact: '["${{ github.token }}","${{ secrets.GITHUB_TOKEN }}"]'
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Trigger and wait for Golang CI Test
      run: |
        echo "Triggering Golang CI workflow..."
        gh workflow run test-golang-ci.yaml -f branch=dev
        
        echo "Waiting for workflow to start..."
        sleep 15
        
        echo "Getting latest run ID..."
        run_id=$(gh run list --workflow=test-golang-ci.yaml --limit 1 --json databaseId --jq '.[0].databaseId')
        
        echo "Waiting for run $run_id to complete..."
        gh run watch $run_id --exit-status
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      actions: read
  trigger-docker-buildx-ci-test:
    runs-on: ubuntu-latest
    steps:
      - uses: plengauer/opentelemetry-github/actions/instrument/job@v5.32.0
        env:
          OTEL_EXPORTER_OTLP_ENDPOINT: https://ingress.coralogix.us:443
          OTEL_EXPORTER_OTLP_HEADERS: 'Authorization: Bearer ${{ secrets.FASTCI_TOKEN }}'
        with:
          secrets_to_redact: '["${{ github.token }}","${{ secrets.GITHUB_TOKEN }}"]'
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Trigger and wait for Docker Buildx CI Test
      run: |
        echo "Triggering Docker Buildx CI workflow..."
        gh workflow run test-docker-buildx-ci.yaml -f branch=dev
        
        echo "Waiting for workflow to start..."
        sleep 15
        
        echo "Getting latest run ID..."
        run_id=$(gh run list --workflow=test-docker-buildx-ci.yaml --limit 1 --json databaseId --jq '.[0].databaseId')
        
        echo "Waiting for run $run_id to complete..."
        gh run watch $run_id --exit-status
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      actions: read
  trigger-gradle-ci-test:
    runs-on: ubuntu-latest
    steps:
      - uses: plengauer/opentelemetry-github/actions/instrument/job@v5.32.0
        env:
          OTEL_EXPORTER_OTLP_ENDPOINT: https://ingress.coralogix.us:443
          OTEL_EXPORTER_OTLP_HEADERS: 'Authorization: Bearer ${{ secrets.FASTCI_TOKEN }}'
        with:
          secrets_to_redact: '["${{ github.token }}","${{ secrets.GITHUB_TOKEN }}"]'
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Trigger and wait for Gradle CI Test
      run: |
        echo "Triggering Gradle CI workflow..."
        gh workflow run test-gradle-ci.yaml -f branch=dev
        
        echo "Waiting for workflow to start..."
        sleep 15
        
        echo "Getting latest run ID..."
        run_id=$(gh run list --workflow=test-gradle-ci.yaml --limit 1 --json databaseId --jq '.[0].databaseId')
        
        echo "Waiting for run $run_id to complete..."
        gh run watch $run_id --exit-status
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      actions: read
