name: ➡️ [Release-Gate] SaaS-promote-version

on:
  workflow_dispatch:
    inputs:
      promotion_stage:
        description: "Select the promotion stage."
        required: true
        type: choice
        options:
          - release-to-dev
          - dev-to-main
      release_branch:
        description: "The full release branch name (e.g., release/v1.2.3)."
        required: true
        type: string
      auto_resolve_conflicts:
        description: "Auto-resolve conflicts by taking release branch code (release-to-dev only)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  release_to_dev:
    if: ${{ inputs.promotion_stage == 'release-to-dev' }}
    runs-on: ubuntu-latest
    environment: GitHub
    outputs:
      pr_url: ${{ steps.capture_pr_url.outputs.pr_url }}
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Extract version from release branch
        id: extract_version
        run: |
          VERSION="${{ inputs.release_branch }}"
          VERSION="${VERSION#release/}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
      - name: Validate release branch format
        shell: bash
        run: |
          set -euo pipefail
          [[ "${{ inputs.release_branch }}" =~ ^release/v[0-9]+\.[0-9]+\.[0-9]+$ ]] || { echo "release_branch must match release/v<semver> (e.g., release/v1.2.3)"; exit 1; }

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all refs
        run: git fetch --prune --tags origin "+refs/heads/*:refs/remotes/origin/*"

      - name: Check and resolve merge conflicts (release -> dev)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "fastci-bot"
          git config user.email "bot@fastci.local"
          
          # Check for conflicts by attempting merge
          git checkout -B temp-check origin/dev
          set +e
          git merge --no-commit --no-ff "origin/${{ inputs.release_branch }}"
          status=$?
          set -e
          
          if [ $status -ne 0 ]; then
            echo "Merge conflicts detected between ${{ inputs.release_branch }} and dev"
            
            if [ "${{ inputs.auto_resolve_conflicts }}" = "true" ]; then
              echo "Auto-resolve enabled: creating resolved merge in temporary branch"
              # Get list of conflicted files
              conflicted_files=$(git diff --name-only --diff-filter=U)
              if [ -n "$conflicted_files" ]; then
                echo "Conflicted files:"
                echo "$conflicted_files"
                # Checkout each conflicted file from release branch
                echo "$conflicted_files" | xargs git checkout --theirs
                git add .
                # Commit the resolved merge
                git commit -m "Merge ${{ inputs.release_branch }} into dev (conflicts resolved using release version)"
                # Push to a temporary branch for PR
                TEMP_BRANCH="auto-merge/${{ inputs.release_branch }}-to-dev"
                git push -f origin "temp-check:${TEMP_BRANCH}"
                echo "RESOLVED_BRANCH=${TEMP_BRANCH}" >> "$GITHUB_ENV"
                echo "HAS_CONFLICTS_RELEASE_TO_DEV=resolved" >> "$GITHUB_ENV"
              else
                echo "No conflicted files found"
                if [ -f .git/MERGE_HEAD ]; then git merge --abort || true; fi
                echo "HAS_CONFLICTS_RELEASE_TO_DEV=true" >> "$GITHUB_ENV"
              fi
            else
              if [ -f .git/MERGE_HEAD ]; then git merge --abort || true; fi
              echo "HAS_CONFLICTS_RELEASE_TO_DEV=true" >> "$GITHUB_ENV"
            fi
          else
            echo "No conflicts detected"
            echo "HAS_CONFLICTS_RELEASE_TO_DEV=false" >> "$GITHUB_ENV"
          fi

      - name: Create PR release -> dev (idempotent)
        id: create_pr
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.FASTCI_GITHUB_PR_TOKEN }}
        run: |
          set -euo pipefail
          # Verify token is valid
          if [ -z "$GH_TOKEN" ]; then
            echo "Error: FASTCI_GITHUB_PR_TOKEN secret is not set in the GitHub environment"
            exit 1
          fi
          if ! gh auth status; then
            echo "Error: FASTCI_GITHUB_PR_TOKEN is invalid or expired. Please regenerate the token."
            exit 1
          fi
          RELEASE="${{ inputs.release_branch }}"
          VERSION="${RELEASE#release/}"
          
          # Determine which branch to use for the PR
          if [ "${HAS_CONFLICTS_RELEASE_TO_DEV}" = "resolved" ]; then
            # Use the temporary resolved branch
            PR_HEAD="${RESOLVED_BRANCH}"
            # Check if PR already exists from temp branch
            existing=$(gh pr list --base dev --head "${PR_HEAD}" --json url -q '.[0].url // ""')
            if [ -n "$existing" ]; then
              echo "PR already exists: $existing"
              exit 0
            fi
            TITLE="[PROMO] Release ${RELEASE} -> dev (conflicts auto-resolved)"
            CONFLICT_NOTE="\n\n✅ Conflicts were automatically resolved by taking the release branch version for all conflicted files.\n\nThis PR merges from temporary branch \`${PR_HEAD}\` which contains the resolved merge."
          else
            # Use the original release branch
            PR_HEAD="${RELEASE}"
            # Check if PR already exists from release branch
            existing=$(gh pr list --base dev --head "${PR_HEAD}" --json url -q '.[0].url // ""')
            if [ -n "$existing" ]; then
              echo "PR already exists: $existing"
              exit 0
            fi
            TITLE="[PROMO] Release ${RELEASE} -> dev"
            CONFLICT_NOTE=""
            if [ "${HAS_CONFLICTS_RELEASE_TO_DEV}" = "true" ]; then
              CONFLICT_NOTE="\n\n⚠️ Merge conflicts detected between ${RELEASE} and dev. Manual resolution will be required."
            fi
          fi
          
          BODY="Promoting version ${VERSION} to the dev branch.${CONFLICT_NOTE}"
          PR_URL=$(gh pr create --base dev --head "${PR_HEAD}" --title "$TITLE" --body "$BODY" --json url -q .url || true)
          if [ -z "$PR_URL" ]; then
            echo "gh pr create failed. If a PR already exists or conflicts occur, treat as skipped."
            exit 0
          fi
          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          
      - name: Capture PR URL
        id: capture_pr_url
        run: |
          # This step exists to ensure output is set even if PR creation was skipped
          echo "pr_url=${{ steps.create_pr.outputs.pr_url || 'N/A' }}" >> $GITHUB_OUTPUT

  dev_to_main:
    if: ${{ inputs.promotion_stage == 'dev-to-main' }}
    runs-on: ubuntu-latest
    environment: GitHub
    outputs:
      pr_url: ${{ steps.capture_pr_url.outputs.pr_url }}
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - name: Extract version from release branch
        id: extract_version
        run: |
          VERSION="${{ inputs.release_branch }}"
          VERSION="${VERSION#release/}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          
      - name: Validate release branch format
        shell: bash
        run: |
          set -euo pipefail
          [[ "${{ inputs.release_branch }}" =~ ^release/v[0-9]+\.[0-9]+\.[0-9]+$ ]] || { echo "release_branch must match release/v<semver> (e.g., release/v1.2.3)"; exit 1; }

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all refs
        run: git fetch --prune --tags origin "+refs/heads/*:refs/remotes/origin/*"

      - name: Run smoke tests (dev -> main)
        shell: bash
        run: |
          set -euo pipefail
          if [ -x scripts/test-dev-to-main.sh ]; then
            bash scripts/test-dev-to-main.sh
          elif [ -x scripts/test-integration.sh ]; then
            bash scripts/test-integration.sh
          elif [ -f package.json ] && command -v npm >/dev/null 2>&1 && grep -q '"test:integration"' package.json; then
            npm ci
            npm run test:integration
          else
            echo "No integration tests found. Skipping."
          fi

      - name: Check merge conflicts (dev -> main)
        shell: bash
        run: |
          set -euo pipefail
          git checkout -B temp-main origin/main
          git config user.name "fastci-bot"
          git config user.email "bot@fastci.local"
          set +e
          git merge --no-commit --no-ff origin/dev
          status=$?
          if [ -f .git/MERGE_HEAD ]; then git merge --abort || true; fi
          set -e
          if [ $status -ne 0 ]; then
            echo "Merge conflicts detected between dev and main"
            echo "HAS_CONFLICTS_DEV_TO_MAIN=true" >> "$GITHUB_ENV"
          else
            echo "HAS_CONFLICTS_DEV_TO_MAIN=false" >> "$GITHUB_ENV"
          fi

      - name: Create PR dev -> main (idempotent)
        id: create_pr
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.FASTCI_GITHUB_PR_TOKEN }}
        run: |
          set -euo pipefail
          # Verify token is valid
          if [ -z "$GH_TOKEN" ]; then
            echo "Error: FASTCI_GITHUB_PR_TOKEN secret is not set in the GitHub environment"
            exit 1
          fi
          if ! gh auth status; then
            echo "Error: FASTCI_GITHUB_PR_TOKEN is invalid or expired. Please regenerate the token."
            exit 1
          fi
          # If PR already exists, exit successfully
          existing=$(gh pr list --base main --head dev --json url -q '.[0].url // ""')
          if [ -n "$existing" ]; then
            echo "PR already exists: $existing"
            exit 0
          fi
          TITLE="[PROMO] Promote dev -> main (includes ${{ inputs.release_branch }})"
          CONFLICT_NOTE=""
          if [ "${HAS_CONFLICTS_DEV_TO_MAIN:-false}" = "true" ]; then
            CONFLICT_NOTE="\n\nNote: Merge conflicts detected between dev and main. Manual resolution will be required."
          fi
          BODY="Promoting dev to main. This promotion includes the merged ${{ inputs.release_branch }}.${CONFLICT_NOTE}"
          PR_URL=$(gh pr create --base main --head dev --title "$TITLE" --body "$BODY" --json url -q .url || true)
          if [ -z "$PR_URL" ]; then
            echo "gh pr create failed. If a PR already exists or conflicts occur, treat as skipped."
            exit 0
          fi
          echo "pr_url=${PR_URL}" >> $GITHUB_OUTPUT
          
      - name: Capture PR URL
        id: capture_pr_url
        run: |
          # This step exists to ensure output is set even if PR creation was skipped
          echo "pr_url=${{ steps.create_pr.outputs.pr_url || 'N/A' }}" >> $GITHUB_OUTPUT

  notify_slack_release_to_dev:
    runs-on: ubuntu-latest
    environment: "Integrations"
    if: always() && inputs.promotion_stage == 'release-to-dev'
    needs: [release_to_dev]
    steps:
      - uses: actions/checkout@v4

      - name: Send Slack Notification
        env:
          SLACK_TOKEN: ${{ secrets.SLACK_FAST_NOTIFIER_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROMOTION_STATUS="success"
          FAILED_JOBS=""
          
          # Check if release_to_dev job failed
          if [ "${{ needs.release_to_dev.result }}" != "success" ]; then
            PROMOTION_STATUS="failure"
            FAILED_JOBS="release_to_dev"
          fi
          
          VERSION="${{ needs.release_to_dev.outputs.version }}"
          PR_URL="${{ needs.release_to_dev.outputs.pr_url }}"
          PROMOTION_STAGE="release-to-dev"
          
          export PROMOTION_STATUS
          export PROMOTION_STAGE
          export VERSION
          export PR_URL
          export FAILED_JOBS
          
          bash .github/scripts/send-promotion-slack-notification.sh

  notify_slack_dev_to_main:
    runs-on: ubuntu-latest
    environment: "Integrations"
    if: always() && inputs.promotion_stage == 'dev-to-main'
    needs: [dev_to_main]
    steps:
      - uses: actions/checkout@v4

      - name: Send Slack Notification
        env:
          SLACK_TOKEN: ${{ secrets.SLACK_FAST_NOTIFIER_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROMOTION_STATUS="success"
          FAILED_JOBS=""
          
          # Check if dev_to_main job failed
          if [ "${{ needs.dev_to_main.result }}" != "success" ]; then
            PROMOTION_STATUS="failure"
            FAILED_JOBS="dev_to_main"
          fi
          
          VERSION="${{ needs.dev_to_main.outputs.version }}"
          PR_URL="${{ needs.dev_to_main.outputs.pr_url }}"
          PROMOTION_STAGE="dev-to-main"
          
          export PROMOTION_STATUS
          export PROMOTION_STAGE
          export VERSION
          export PR_URL
          export FAILED_JOBS
          
          bash .github/scripts/send-promotion-slack-notification.sh
