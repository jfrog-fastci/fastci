name: Sync Beta Branch

on:
  schedule:
    # Run at 00:00 and 12:00 UTC every day
    - cron: '0 0,12 * * *'
  workflow_dispatch:
    inputs:
      message:
        description: 'Message to add to the commit'
        required: false
        default: 'Syncing beta branch'

jobs:
  sync-beta:
    runs-on: ubuntu-latest
    steps:
      - uses: plengauer/opentelemetry-github/actions/instrument/job@v5.32.0
        env:
          OTEL_EXPORTER_OTLP_ENDPOINT: https://ingress.coralogix.us:443
          OTEL_EXPORTER_OTLP_HEADERS: 'Authorization: Bearer ${{ secrets.FASTCI_TOKEN }}'
        with:
          secrets_to_redact: '["${{ github.token }}"]'
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: main

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions@github.com'

      - name: Sync beta branch with main
        run: "# Fetch beta branch if it exists\ngit fetch origin beta || true\n\n# Store beta's action.yml if it exists\nif git show origin/beta:action.yml > /dev/null 2>&1; then\n  git show origin/beta:action.yml > beta_action.yml\nfi\n\n# Create or update beta branch\ngit checkout -B beta\n\n# Restore beta's action.yml if it existed\nif [ -f beta_action.yml ]; then\n  mv beta_action.yml action.yml\n  git add action.yml\n  git commit -m \"Preserve beta-specific action.yml changes\"\nfi\n\n# Push changes\ngit push origin beta --force "
    permissions:
      actions: read
