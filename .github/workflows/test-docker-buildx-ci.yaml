name: "\U0001F9EA [Release-Gate] Docker Buildx CI"
run-name: Docker Buildx Test

permissions:
  actions: read
  contents: read

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Select the FastCI branch to use'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - main
          - disabled
  # This will also run the workflow automatically on every push to the 'dev' branch
  push:
    branches:
      - dev

jobs:
  docker-buildx-cli:
    name: "Build with Docker Buildx CLI FastCI: ${{ matrix.fastci_enabled }}"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fastci_enabled: [true, false]
    steps:
      - uses: plengauer/opentelemetry-github/actions/instrument/job@v5.32.0
        env:
          OTEL_EXPORTER_OTLP_ENDPOINT: https://ingress.coralogix.us:443
          OTEL_EXPORTER_OTLP_HEADERS: 'Authorization: Bearer ${{ secrets.FASTCI_TOKEN }}'
        with:
          secrets_to_redact: '["${{ github.token }}","${{ secrets.FASTCI_TOKEN }}","${{secrets.GITHUB_TOKEN}}"]'
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Start FastCI Optimization (dev)
        # Check for dispatch input OR a push event
        if: matrix.fastci_enabled == true && (inputs.branch == 'dev' || github.event_name == 'push')
        uses: jfrog-fastci/fastci@dev
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          fastci_otel_token: ${{ secrets.FASTCI_TOKEN }}
          install_bashi: true
          bashi_log_level: 'debug'

      - name: Start FastCI Optimization (main)
        # This will correctly only run on dispatch
        if: matrix.fastci_enabled == true && inputs.branch == 'main'
        uses: jfrog-fastci/fastci@main
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          fastci_otel_token: ${{ secrets.FASTCI_TOKEN }}
          install_bashi: true
          bashi_log_level: 'debug'

      # --- FIXED INDENTATION ---
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build with Buildx CLI
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --tag fastci:latest \
            --file Dockerfile \
            .
    permissions:
      actions: read
  docker-buildx-action:
    name: "Build with Docker Buildx Action FastCI: ${{ matrix.fastci_enabled }}"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fastci_enabled: [true, false]
    steps:
      - uses: plengauer/opentelemetry-github/actions/instrument/job@v5.32.0
        env:
          OTEL_EXPORTER_OTLP_ENDPOINT: https://ingress.coralogix.us:443
          OTEL_EXPORTER_OTLP_HEADERS: 'Authorization: Bearer ${{ secrets.FASTCI_TOKEN }}'
        with:
          secrets_to_redact: '["${{ github.token }}","${{ secrets.FASTCI_TOKEN }}","${{secrets.GITHUB_TOKEN}}"]'
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Start FastCI Optimization (dev)
        # Check for dispatch input OR a push event
        if: matrix.fastci_enabled == true && (inputs.branch == 'dev' || github.event_name == 'push')
        uses: jfrog-fastci/fastci@dev
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          fastci_otel_token: ${{ secrets.FASTCI_TOKEN }}
          install_bashi: true
          bashi_log_level: 'debug'

      - name: Start FastCI Optimization (main)
        # This will correctly only run on dispatch
        if: matrix.fastci_enabled == true && inputs.branch == 'main'
        uses: jfrog-fastci/fastci@main
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          fastci_otel_token: ${{ secrets.FASTCI_TOKEN }}
          install_bashi: true
          bashi_log_level: 'debug'

      # --- FIXED INDENTATION ---
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build with Buildx Action
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          tags: fastci:latest
          push: false
    permissions:
      actions: read
  docker-native-build:
    name: "Build with Native Docker FastCI: ${{ matrix.fastci_enabled }}"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        fastci_enabled: [true, false]
    steps:
      - uses: plengauer/opentelemetry-github/actions/instrument/job@v5.32.0
        env:
          OTEL_EXPORTER_OTLP_ENDPOINT: https://ingress.coralogix.us:443
          OTEL_EXPORTER_OTLP_HEADERS: 'Authorization: Bearer ${{ secrets.FASTCI_TOKEN }}'
        with:
          secrets_to_redact: '["${{ github.token }}","${{ secrets.FASTCI_TOKEN }}","${{secrets.GITHUB_TOKEN}}"]'
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: Start FastCI Optimization (dev)
        # Check for dispatch input OR a push event
        if: matrix.fastci_enabled == true && (inputs.branch == 'dev' || github.event_name == 'push')
        uses: jfrog-fastci/fastci@dev
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          fastci_otel_token: ${{ secrets.FASTCI_TOKEN }}
          install_bashi: true
          bashi_log_level: 'debug'

      - name: Start FastCI Optimization (main)
        # This will correctly only run on dispatch
        if: matrix.fastci_enabled == true && inputs.branch == 'main'
        uses: jfrog-fastci/fastci@main
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          fastci_otel_token: ${{ secrets.FASTCI_TOKEN }}
          install_bashi: true
          bashi_log_level: 'debug'

      # --- FIXED INDENTATION ---
      - name: Build with Native Docker
        env:
          DOCKER_BUILDKIT: 0
        run: |
          docker build \
            --tag fastci:latest \
            --file Dockerfile \
            .
    permissions:
      actions: read
